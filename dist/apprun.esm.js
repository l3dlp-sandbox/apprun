const t="3.36.0",n=`AppRun-${t}`;class e{constructor(){this._events={}}on(t,n,e={}){this._events[t]=this._events[t]||[],this._events[t].push({fn:n,options:e})}off(t,n){const e=this._events[t]||[];this._events[t]=e.filter((t=>t.fn!==n))}find(t){return this._events[t]}run(t,...n){const e=this.getSubscribers(t,this._events);return console.assert(e&&e.length>0,"No subscriber for event: "+t),e.forEach((e=>{const{fn:o,options:i}=e;if(!o||"function"!=typeof o)return console.error(`AppRun event handler for '${t}' is not a function:`,o),!1;if(i.delay)this.delay(t,o,n,i);else try{Object.keys(i).length>0?o.apply(this,[...n,i]):o.apply(this,n)}catch(n){console.error(`Error in event handler for '${t}':`,n)}return!e.options.once})),e.length}once(t,n,e={}){this.on(t,n,Object.assign(Object.assign({},e),{once:!0}))}delay(t,n,e,o){o._t&&clearTimeout(o._t),o._t=setTimeout((()=>{clearTimeout(o._t);try{Object.keys(o).length>0?n.apply(this,[...e,o]):n.apply(this,e)}catch(n){console.error(`Error in delayed event handler for '${t}':`,n)}}),o.delay)}runAsync(t,...n){const e=this.getSubscribers(t,this._events);console.assert(e&&e.length>0,"No subscriber for event: "+t);const o=e.map((e=>{const{fn:o,options:i}=e;if(!o||"function"!=typeof o)return console.error(`AppRun async event handler for '${t}' is not a function:`,o),Promise.resolve(null);try{return Object.keys(i).length>0?o.apply(this,[...n,i]):o.apply(this,n)}catch(n){return console.error(`Error in async event handler for '${t}':`,n),Promise.reject(n)}}));return Promise.all(o)}query(t,...n){return this.runAsync(t,...n)}getSubscribers(t,n){const e=n[t]||[];return n[t]=e.filter((t=>!t.options.once)),Object.keys(n).filter((n=>n.endsWith("*")&&t.startsWith(n.replace("*","")))).sort(((t,n)=>n.length-t.length)).forEach((o=>e.push(...n[o].map((n=>Object.assign(Object.assign({},n),{options:Object.assign(Object.assign({},n.options),{event:t})})))))),e}}const o=n;let i;const s="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};s.app&&s._AppRunVersions?i=s.app:(i=new e,s.app=i,s._AppRunVersions=o);var r=i;function c(t){return(null==t?void 0:t.target)instanceof HTMLElement?t.target:null}const u=(t,n)=>(n?t.state[n]:t.state)||"",h=(t,n,e)=>{if(n){const o=t.state||{};o[n]=e,t.setState(o)}else t.setState(e)},l=(t,n)=>{if(Array.isArray(t))return t.map((t=>l(t,n)));{let{type:e,tag:o,props:i,children:s}=t;return o=o||e,s=s||(null==i?void 0:i.children),i&&Object.keys(i).forEach((t=>{t.startsWith("$")&&(((t,n,e,o)=>{if(t.startsWith("$on")){const e=n[t];if(t=t.substring(1),"boolean"==typeof e)n[t]=n=>o.run?o.run(t,n):r.run(t,n);else if("string"==typeof e)n[t]=t=>o.run?o.run(e,t):r.run(e,t);else if("function"==typeof e)n[t]=t=>o.setState(e(o.state,t));else if(Array.isArray(e)){const[i,...s]=e;"string"==typeof i?n[t]=t=>o.run?o.run(i,...s,t):r.run(i,...s,t):"function"==typeof i&&(n[t]=t=>o.setState(i(o.state,...s,t)))}}else if("$bind"===t){const i=n.type||"text",s="string"==typeof n[t]?n[t]:n.name;if("input"===e)switch(i){case"checkbox":n.checked=u(o,s),n.onclick=t=>{const n=c(t);n&&h(o,s||n.name,n.checked)};break;case"radio":n.checked=u(o,s)===n.value,n.onclick=t=>{const n=c(t);n&&h(o,s||n.name,n.value)};break;case"number":case"range":n.value=u(o,s),n.oninput=t=>{const n=c(t);n&&h(o,s||n.name,Number(n.value))};break;default:n.value=u(o,s),n.oninput=t=>{const n=c(t);n&&h(o,s||n.name,n.value)}}else"select"===e?(n.value=u(o,s),n.onchange=t=>{const n=c(t);n&&!n.multiple&&h(o,s||n.name,n.value)}):"option"===e?(n.selected=u(o,s),n.onclick=t=>{const n=c(t);n&&h(o,s||n.name,n.selected)}):"textarea"===e&&(n.innerHTML=u(o,s),n.oninput=t=>{const n=c(t);n&&h(o,s||n.name,n.value)})}else r.run("$",{key:t,tag:e,props:n,component:o})})(t,i,o,n),delete i[t])})),s&&l(s,n),t}};function f(t,...n){return d(n)}const a="_props";function d(t){const n=[],e=t=>{null!=t&&""!==t&&!1!==t&&n.push("function"==typeof t||"object"==typeof t?t:`${t}`)};return t&&t.forEach((t=>{Array.isArray(t)?t.forEach((t=>e(t))):e(t)})),n}const p=(t,n,e={})=>{if(null==n||!1===n)return;!function(t,n,e={}){if(null==n||!1===n)return;if(n=j(n,e),!t)return;const o="SVG"===t.nodeName;Array.isArray(n)?b(t,n,o):b(t,[n],o)}("string"==typeof t&&t?document.getElementById(t)||document.querySelector(t):t,n=l(n,e),e)};function y(t,n,e){e=e||"svg"===n.tag,function(t,n){const e=t.nodeName,o=`${n.tag||""}`;return e.toUpperCase()===o.toUpperCase()}(t,n)?(b(t,n.children,e),w(t,n.props,e)):t.parentNode.replaceChild(g(n,e),t)}function b(t,n,e){var o;const i=(null===(o=t.childNodes)||void 0===o?void 0:o.length)||0,s=(null==n?void 0:n.length)||0;if(null==n?void 0:n.some((t=>t&&"object"==typeof t&&t.props&&void 0!==t.props.key))){const o=new Map;for(let n=0;n<i;n++){const e=t.childNodes[n];e&&e.key&&o.set(e.key,e)}const r=document.createDocumentFragment();for(let t=0;t<s;t++){const i=n[t];if(null==i)continue;const s=i.props&&i.props.key;if(s&&o.has(s)){const t=o.get(s);y(t,i,e),r.appendChild(t),o.delete(s)}else r.appendChild(g(i,e))}for(;t.firstChild;)t.removeChild(t.firstChild);return void t.appendChild(r)}const r=Math.min(i,s);for(let o=0;o<r;o++){const i=n[o];if(null==i)continue;const s=t.childNodes[o];s&&("string"==typeof i?3===s.nodeType?s.nodeValue!==i&&(s.nodeValue=i):t.replaceChild(v(i),s):i instanceof HTMLElement||i instanceof SVGElement?t.replaceChild(i,s):i&&"object"==typeof i&&y(t.childNodes[o],i,e))}for(;t.childNodes.length>r;)t.removeChild(t.lastChild);if(s>r){const o=document.createDocumentFragment();for(let t=r;t<n.length;t++){const i=n[t];null!=i&&o.appendChild(g(i,e))}t.appendChild(o)}}const m=t=>{const n=document.createElement("section");return n.insertAdjacentHTML("afterbegin",t),Array.from(n.children)};function v(t){if(0===(null==t?void 0:t.indexOf("_html:"))){const n=document.createElement("div");return n.insertAdjacentHTML("afterbegin",t.substring(6)),n}return document.createTextNode(null!=t?t:"")}function g(t,n){if(t instanceof HTMLElement||t instanceof SVGElement)return t;if("string"==typeof t)return v(t);if(!t||"object"!=typeof t||!t.tag||"function"==typeof t.tag)return v("object"==typeof t?JSON.stringify(t):String(null!=t?t:""));const e=(n=n||"svg"===t.tag)?document.createElementNS("http://www.w3.org/2000/svg",t.tag):document.createElement(t.tag);return w(e,t.props,n),t.children&&t.children.forEach((t=>e.appendChild(g(t,n)))),e}function w(t,n,e){const o=t[a]||{};n=function(t,n){n.class=n.class||n.className,delete n.className;const e={};return t&&Object.keys(t).forEach((t=>e[t]=null)),Object.keys(n).forEach((t=>e[t]=n[t])),e}(o,n||{}),t[a]=n;for(const o in n){const i=n[o];if(o.startsWith("data-")){const n=o.substring(5).replace(/-(\w)/g,(t=>t[1].toUpperCase()));t.dataset[n]!==i&&(i||""===i?t.dataset[n]=i:delete t.dataset[n])}else if("style"===o)if(t.style.cssText&&(t.style.cssText=""),"string"==typeof i)t.style.cssText=i;else for(const n in i)t.style[n]!==i[n]&&(t.style[n]=i[n]);else if(o.startsWith("xlink")){const n=o.replace("xlink","").toLowerCase();null==i||!1===i?t.removeAttributeNS("http://www.w3.org/1999/xlink",n):t.setAttributeNS("http://www.w3.org/1999/xlink",n,i)}else o.startsWith("on")?i&&"function"!=typeof i?"string"==typeof i&&(i?t.setAttribute(o,i):t.removeAttribute(o)):t[o]=i:/^id$|^class$|^list$|^readonly$|^contenteditable$|^role|-|^for$/g.test(o)||e?t.getAttribute(o)!==i&&(i?t.setAttribute(o,i):t.removeAttribute(o)):t[o]!==i&&(t[o]=i);"key"===o&&void 0!==i&&(t.key=i)}n&&"function"==typeof n.ref&&window.requestAnimationFrame((()=>n.ref(t)))}function j(t,n,e=0){var o;if("string"==typeof t)return t;if(Array.isArray(t))return t.map((t=>j(t,n,e++)));let i=t;if(t&&"function"==typeof t.tag&&Object.getPrototypeOf(t.tag).t&&(i=function(t,n,e){const{tag:o,props:i,children:s}=t;let r=`_${e}`,c=i&&i.id;c?r=c:c=`_${e}${Date.now()}`;let u="section";i&&i.as&&(u=i.as,delete i.as),n.o||(n.o={});let h=n.o[r];if(h&&h instanceof o&&h.element)h.renderState(h.state);else{const t=document.createElement(u);h=n.o[r]=new o(Object.assign(Object.assign({},i),{children:s})).mount(t,{render:!0})}if(h.mounted){const t=h.mounted(i,s,h.state);void 0!==t&&h.setState(t)}return w(h.element,i,!1),h.element}(t,n,e)),i&&Array.isArray(i.children)){const t=null===(o=i.props)||void 0===o?void 0:o._component;if(t){let n=0;i.children=i.children.map((e=>j(e,t,n++)))}else i.children=i.children.map((t=>j(t,n,e++)))}return i}const O=(t,n={})=>class extends HTMLElement{constructor(){super()}get component(){return this._component}get state(){return this._component.state}static get observedAttributes(){return(n.observedAttributes||[]).map((t=>t.toLowerCase()))}connectedCallback(){if(this.isConnected&&!this._component){const e=n||{};this._shadowRoot=e.shadow?this.attachShadow({mode:"open"}):this;const o=e.observedAttributes||[],i=o.reduce(((t,n)=>{const e=n.toLowerCase();return e!==n&&(t[e]=n),t}),{});this._attrMap=t=>i[t]||t;const s={};Array.from(this.attributes).forEach((t=>s[this._attrMap(t.name)]=t.value)),o.forEach((t=>{void 0!==this[t]&&(s[t]=this[t]),Object.defineProperty(this,t,{get:()=>s[t],set(n){this.attributeChangedCallback(t,s[t],n)},configurable:!0,enumerable:!0})})),requestAnimationFrame((()=>{const n=this.children?Array.from(this.children):[];if(this._component=new t(Object.assign(Object.assign({},s),{children:n})).mount(this._shadowRoot,e),this._component._props=s,this._component.dispatchEvent=this.dispatchEvent.bind(this),this._component.mounted){const t=this._component.mounted(s,n,this._component.state);void 0!==t&&(this._component.state=t)}this.on=this._component.on.bind(this._component),this.run=this._component.run.bind(this._component),!1!==e.render&&this._component.run(".")}))}}disconnectedCallback(){var t,n,e,o;null===(n=null===(t=this._component)||void 0===t?void 0:t.unload)||void 0===n||n.call(t),null===(o=null===(e=this._component)||void 0===e?void 0:e.unmount)||void 0===o||o.call(e),this._component=null}attributeChangedCallback(t,e,o){if(this._component){const i=this._attrMap(t);this._component._props[i]=o,this._component.run("attributeChanged",i,e,o),o!==e&&!1!==n.render&&window.requestAnimationFrame((()=>{this._component.run(".")}))}}};var $=(t,n,e)=>{"undefined"!=typeof customElements&&customElements.define(t,O(n,e))};const A={meta:new WeakMap,defineMetadata(t,n,e){this.meta.has(e)||this.meta.set(e,{}),this.meta.get(e)[t]=n},getMetadataKeys(t){return t=Object.getPrototypeOf(t),this.meta.get(t)?Object.keys(this.meta.get(t)):[]},getMetadata(t,n){return n=Object.getPrototypeOf(n),this.meta.get(n)?this.meta.get(n)[t]:null}};function _(t,n={}){return(e,o,i)=>{const s=t?t.toString():o;return A.defineMetadata(`apprun-update:${s}`,{name:s,key:o,options:n},e),i}}function k(t,n={}){return function(e,o){const i=t?t.toString():o;A.defineMetadata(`apprun-update:${i}`,{name:i,key:o,options:n},e)}}function M(t,n){return function(e){return $(t,e,n),e}}const R=new Map;r.find("get-components")||r.on("get-components",(t=>t.components=R));const E=t=>t;class S{renderState(t,n=null){if(!this.view)return;let e=n||this.view(t);if(r.debug&&r.run("debug",{component:this,_:e?".":"-",state:t,vdom:e,el:this.element}),"object"!=typeof document)return;const o="string"==typeof this.element&&this.element?function(t){try{return document.getElementById(t)}catch(n){return console.warn(`Error getting element by id: ${t}`,n),null}}(this.element)||function(t,n=document){try{return n.querySelector(t)}catch(n){return console.warn(`Invalid selector: ${t}`,n),null}}(this.element):this.element;if(!o)return void console.warn(`Component element not found: ${this.element}`);const i="_c";this.unload?o._component===this&&o.getAttribute(i)===this.tracking_id||(this.tracking_id=(new Date).valueOf().toString(),o.setAttribute(i,this.tracking_id),"undefined"!=typeof MutationObserver&&(this.observer||(this.observer=new MutationObserver((t=>{t[0].oldValue!==this.tracking_id&&document.body.contains(o)||(this.unload(this.state),this.observer.disconnect(),this.observer=null)}))),this.observer.observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeOldValue:!0,attributeFilter:[i]}))):o.removeAttribute&&o.removeAttribute(i),o._component=this,!n&&e&&(e=l(e,this),this.options.transition&&document&&document.startViewTransition?document.startViewTransition((()=>r.render(o,e,this))):r.render(o,e,this)),this.rendered&&this.rendered(this.state)}setState(t,n={render:!0,history:!1}){const e=async t=>{try{for(;;){const{value:e,done:o}=await t.next();if(o)break;this.setState(e,n)}}catch(t){console.error("Error in async iterator:",t)}},o=t;if(null==o?void 0:o[Symbol.asyncIterator])this.setState(e(o[Symbol.asyncIterator]()),n);else if((null==o?void 0:o[Symbol.iterator])&&"function"==typeof o.next)for(const t of o)this.setState(t,n);else if(t&&t instanceof Promise)Promise.resolve(t).then((e=>{this.setState(e,n),this._state=t}));else{if(this._state=t,null==t)return;this.state=t,!1!==n.render&&(n.transition&&document&&document.startViewTransition?document.startViewTransition((()=>this.renderState(t))):this.renderState(t)),!1!==n.history&&this.enable_history&&(this._history=[...this._history,t],this._history_idx=this._history.length-1),"function"==typeof n.callback&&n.callback(this.state)}}constructor(t,n,o,i){this.state=t,this.view=n,this.update=o,this.options=i,this._app=new e,this._actions=[],this._global_events=[],this._history=[],this._history_idx=-1,this._history_prev=()=>{this._history_idx--,this._history_idx>=0?this.setState(this._history[this._history_idx],{render:!0,history:!1}):this._history_idx=0},this._history_next=()=>{this._history_idx++,this._history_idx<this._history.length?this.setState(this._history[this._history_idx],{render:!0,history:!1}):this._history_idx=this._history.length-1},this.start=(t=null,n)=>{if(this.mount(t,Object.assign({render:!0},n)),this.mounted&&"function"==typeof this.mounted){const t=this.mounted({},[],this.state);void 0!==t&&this.setState(t)}return this}}mount(t=null,n){var e,o;return console.assert(!this.element,"Component already mounted."),this.options=n=Object.assign(Object.assign({},this.options),n),this.element=t,this.global_event=n.global_event,this.enable_history=!!n.history,this.enable_history&&(this.on(n.history.prev||"history-prev",this._history_prev),this.on(n.history.next||"history-next",this._history_next)),n.route&&(this.update=this.update||{},this.update[n.route]||(this.update[n.route]=E)),this.add_actions(),this.state=null!==(o=null!==(e=this.state)&&void 0!==e?e:this.model)&&void 0!==o?o:{},"function"==typeof this.state&&(this.state=this.state()),this.setState(this.state,{render:!!n.render,history:!0}),r.debug&&(R.get(t)?R.get(t).push(this):R.set(t,[this])),this}is_global_event(t){return t&&(this.global_event||this._global_events.indexOf(t)>=0||t.startsWith("#")||t.startsWith("/")||t.startsWith("@"))}add_action(t,n,e={}){n&&"function"==typeof n?(e.global&&this._global_events.push(t),this.on(t,((...o)=>{r.debug&&r.run("debug",{component:this,_:">",event:t,p:o,current_state:this.state,options:e});try{const i=n(this.state,...o);r.debug&&r.run("debug",{component:this,_:"<",event:t,p:o,newState:i,state:this.state,options:e}),this.setState(i,e)}catch(n){console.error(`Error in component action '${t}':`,n),r.debug&&r.run("debug",{component:this,_:"!",event:t,p:o,error:n,state:this.state,options:e})}}),e)):console.warn(`Component action for '${t}' is not a valid function:`,n)}add_actions(){const t=this.update||{};A.getMetadataKeys(this).forEach((n=>{if(n.startsWith("apprun-update:")){const e=A.getMetadata(n,this);t[e.name]=[this[e.key].bind(this),e.options]}}));const n={};Array.isArray(t)?t.forEach((t=>{const[e,o,i]=t;e.toString().split(",").forEach((t=>n[t.trim()]=[o,i]))})):Object.keys(t).forEach((e=>{const o=t[e];("function"==typeof o||Array.isArray(o))&&e.split(",").forEach((t=>n[t.trim()]=o))})),n["."]||(n["."]=E),Object.keys(n).forEach((t=>{const e=n[t];"function"==typeof e?this.add_action(t,e):Array.isArray(e)&&this.add_action(t,e[0],e[1])}))}run(t,...n){if(this.state instanceof Promise)return Promise.resolve(this.state).then((e=>{this.state=e,this.run(t,...n)}));{const e=t.toString();return this.is_global_event(e)?r.run(e,...n):this._app.run(e,...n)}}on(t,n,e){const o=t.toString();return this._actions.push({name:o,fn:n}),this.is_global_event(o)?r.on(o,n,e):this._app.on(o,n,e)}runAsync(t,...n){const e=t.toString();return this.is_global_event(e)?r.runAsync(e,...n):this._app.runAsync(e,...n)}query(t,...n){return this.runAsync(t,...n)}unmount(){var t;null===(t=this.observer)||void 0===t||t.disconnect(),this._actions.forEach((t=>{const{name:n,fn:e}=t;this.is_global_event(n)?r.off(n,e):this._app.off(n,e)}))}}S.t=!0;const x="//",C="///",P=t=>{if(r.lastUrl!==t)if(r.lastUrl=t,t||(t="#"),t.startsWith("#")){const[n,...e]=t.split("/");r.run(n,...e)||r.run(C,n,...e),r.run(x,n,...e)}else if(t.startsWith("/")){const[n,e,...o]=t.split("/");r.run("/"+e,...o)||r.run(C,"/"+e,...o),r.run(x,"/"+e,...o)}else r.run(t)||r.run(C,t),r.run(x,t)};if(!r.start){r.version=t,r.h=r.createElement=function(t,n,...e){const o=d(e);if("string"==typeof t)return{tag:t,props:n,children:o};if(Array.isArray(t))return t;if(void 0===t&&e)return o;if(Object.getPrototypeOf(t).t)return{tag:t,props:n,children:o};if("function"==typeof t)return t(n,o);throw new Error(`Unknown tag in vdom ${t}`)},r.render=p,r.Fragment=f,r.webComponent=$,r.safeHTML=m,r.start=(t,n,e,o,i)=>{const s=Object.assign({render:!0,global_event:!0},i),r=new S(n,e,o);return i&&i.rendered&&(r.rendered=i.rendered),i&&i.mounted&&(r.mounted=i.mounted),r.start(t,s),r},r.once=r.once||((t,n,e={})=>{r.on(t,n,Object.assign(Object.assign({},e),{once:!0}))}),r.query=r.query||r.runAsync;const n=t=>{};if(r.on("debug",(t=>n)),r.on(x,n),r.on(C,n),r.route=P,r.on("route",(t=>r.route&&r.route(t))),"object"==typeof document&&document.addEventListener("DOMContentLoaded",(()=>{const t=document.body.hasAttribute("apprun-no-init")||r["no-init-route"]||!1,n=r.find("#")||r.find("#/")||!1;window.addEventListener("hashchange",(()=>P(location.hash))),window.addEventListener("popstate",(()=>P(location.pathname))),n?!t&&P(location.hash):(!t&&P(location.pathname),document.body.addEventListener("click",(t=>{const n=t.target;if(!n)return;const e="A"===n.tagName?n:n.closest("a");e&&e.origin===location.origin&&e.pathname&&(t.preventDefault(),history.pushState(null,"",e.pathname),P(e.pathname))})))})),"object"==typeof window){const t=window;t.Component=S,t._React=t.React,t.React=r,t.on=k,t.customElement=M,t.safeHTML=m}r.use_render=(t,n=0)=>{r.render=0===n?(n,e)=>t(e,n):(n,e)=>t(n,e)},r.use_react=(t,n)=>{if(t&&n)if("function"==typeof t.createElement)if(t.Fragment)if(r.h=r.createElement=t.createElement,r.Fragment=t.Fragment,t.version&&t.version.startsWith("18")){if(!n.createRoot||"function"!=typeof n.createRoot)return void console.error("AppRun use_react: ReactDOM.createRoot not found in React 18+");r.render=(t,e)=>{t&&void 0!==e&&(t._root||(t._root=n.createRoot(t)),t._root.render(e))}}else{if(!n.render||"function"!=typeof n.render)return void console.error("AppRun use_react: ReactDOM.render not found in legacy React");r.render=(t,e)=>n.render(e,t)}else console.error("AppRun use_react: Invalid React object - Fragment not found");else console.error("AppRun use_react: Invalid React object - createElement method not found");else console.error("AppRun use_react: React and ReactDOM parameters are required")}}export{e as App,S as Component,f as Fragment,C as ROUTER_404_EVENT,x as ROUTER_EVENT,r as app,M as customElement,r as default,_ as event,k as on,m as safeHTML,_ as update};
//# sourceMappingURL=apprun.esm.js.map
